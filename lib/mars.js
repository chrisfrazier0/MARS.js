function preprocess(e){let a,t=e.match(/^[\x20\t\r\f\v]*;[\x20\t\r\f\v]*name\x20(.*)$/m);null!==t&&(a=t[1].trim());const s=new RegExp(String.raw`[\x20\t\r\f\v]*([a-z_]\w*)[\x20\t\r\f\v]*:?[\x20\t\r\f\v]*EQU\x20([^\n]*)`,"ig");let r=0,n="";const c=new Map;for(;t=s.exec(e);)c.set(t[1],t[2]),n+=e.slice(r,t.index),r=t.index+t[0].length;return[a,n+=e.slice(r),c]}const modifiers=["AB","BA","A","B","F","X","I"],opcodes=["DAT","MOV","ADD","SUB","MUL","DIV","MOD","JMP","JMZ","JMN","DJN","CMP","SEQ","SNE","SLT","SPL","NOP"];function lexer(e,a=new Map){const t=new RegExp(String.raw`([\x20\t\r\f\v]+)|(;[^\n]*)|([a-zA-Z_]\w*)|([#$@{}<>])|(\d+)|([\n.,:()+\-*/%])`,"y");let s=1,r=1;const n=function(e,a){const t={type:e,value:a,line:s,col:r};return r+=a.length,t},c=function(){if(t.lastIndex>=e.length)return{type:"eof",value:"eof",line:s,col:r};const c=t.lastIndex,o=t.exec(e);if(null===o)throw new SyntaxError(`Unexpected character "${e[c]}" at ${s}:${r}`);if(void 0!==o[1]||void 0!==o[2])r+=o[0].length;else if(void 0!==o[3]){const s=o[3].toUpperCase();if("ORG"===s)return n("org",o[3]);if("END"===s)return n("end",o[3]);if(-1!==opcodes.indexOf(s))return n("opcode",o[3]);if(-1!==modifiers.indexOf(s))return n("modifier",o[3]);if(!a.has(o[3]))return n("label",o[3]);e=a.get(o[3])+e.slice(t.lastIndex),t.lastIndex=0}else{if(void 0!==o[4])return n("mode",o[4]);if(void 0!==o[5])return n("number",o[5]);if(void 0!==o[6]){const e=n("punc",o[6]);return"\n"===e.value&&(s+=1,r=1),e}}};return function(){let e;for(;void 0===e;)e=c();return e}}let lex,la,org,labels,count;const symbol_table={},itself=function(){return this},symbol=function(e,a=0){let t=symbol_table[e];return t?a>t.lbp&&(t.lbp=a):((t=Object.create(symbol_original)).type=t.value=e,t.lbp=a,symbol_table[e]=t),t},symbol_original={std(){const e=this.type===this.value?this.type:this.type+":"+this.value;throw new SyntaxError(`Expected instruction but found "${e}" at ${this.line}:${this.col}`)},nud(){const e=this.type===this.value?this.type:this.type+":"+this.value;throw new SyntaxError(`Expected expression but found "${e}" at ${this.line}:${this.col}`)},led(){throw new Error("Missing operator led() definition")}},create_symbol=function(e,a){const t=Object.create(symbol(e));return void 0!==a&&(t.value=a),t},advance=function(e){if(void 0!==e&&la.type!==e){const a="\n"===e?"EOL":'"'+e+'"',t=la.type===la.value?la.type:la.type+":"+la.value;throw new SyntaxError(`Expected ${a} but found "${t}" at ${la.line}:${la.col}`)}const a=la,t=lex();return(la=create_symbol("punc"===t.type?t.value:t.type,t.value)).col=t.col,la.line=t.line,a},statements=function(){const e=[];for(;"eof"!==la.type;){const a=advance().std();if(!1===a)break;void 0!==a&&e.push(a)}return e},label=function(){if(labels.set(this.value,count),":"===la.type&&advance(),"opcode"===la.type)return advance().std();"eof"!==la.type&&advance("\n")},opcode=function(){count+=1;const e=create_symbol("instruction",this.value);return"."===la.type&&(advance(),e.modifier=advance("modifier").value),e.a=reference(),","===la.type?(advance(),e.b=reference()):"DAT"!==e.value.toUpperCase()?(e.b=create_symbol("operand",create_symbol("number",0)),e.b.mode="$"):(e.b=e.a,e.a=create_symbol("operand",create_symbol("number",0)),e.a.mode="$"),"eof"!==la.type&&advance("\n"),e},reference=function(){const e=create_symbol("operand");return"mode"===la.type||"*"===la.type?e.mode=advance().value:e.mode="$",e.value=expression(),e},expression=function(e=0){let a=advance(),t=a.nud();for(;e<la.lbp;)t=(a=advance()).led(t);return t},infix=function(e,a){const t=symbol(e,a);return t.led=function(e){return this.first=e,this.second=expression(a),this},t},prefix=function(e,a){const t=symbol(e);return t.nud=function(){return this.first=expression(a),this},t};function parse(e){lex=e,org=create_symbol("number",0),labels=new Map,count=0,advance();const a=statements();return[org,labels,a]}symbol("org").std=function(){org=expression(),"eof"!==la.type&&advance("\n")},symbol("end").std=function(){return"\n"!==la.type&&"eof"!==la.type&&(org=expression(),"eof"!==la.type&&advance("\n")),!1},symbol("label").std=label,symbol("modifier").std=label,symbol("opcode").std=opcode,symbol("\n").std=function(){},symbol("number").nud=itself,symbol("label").nud=itself,symbol("modifier").nud=itself,symbol("(").nud=function(){const e=expression();return advance(")"),e},infix("+",10),infix("-",10),infix("*",20),infix("/",20),infix("%",20),prefix("-",30);const fDefault=["DAT","NOP"],bDefault=["JMP","JMZ","JMN","DJN","SPL"],iFinal=["MOV","CMP","SEQ","SNE"],fFinal=["ADD","SUB","MUL","DIV","MOD"];function compile(e,a,t){let s,r=0;const n=function(e){switch(e.type){case"number":return Number(e.value);case"label":case"modifier":if(void 0===(s=a.get(e.value)))throw new SyntaxError(`Unknow label "${e.value}" at ${e.line}:${e.col}`);return s-r;case"+":return n(e.first)+n(e.second);case"-":return void 0===e.second?-n(e.first):n(e.first)-n(e.second);case"*":return n(e.first)*n(e.second);case"/":return n(e.first)/n(e.second);case"%":return n(e.first)%n(e.second);default:throw new SyntaxError(`Unexpected symbol "${e.type}:${e.value}" at ${e.line}:${e.col}`)}};e=n(e);const c=[];for(;r<t.length;r++){const e=t[r];let a=e.value.toUpperCase(),s=e.modifier&&e.modifier.toUpperCase()||"?";"?"===s&&(s=-1!==fDefault.indexOf(a)?"F":-1!==bDefault.indexOf(a)?"B":"#"===e.a.mode?"AB":"#"===e.b.mode?"B":-1!==iFinal.indexOf(a)?"I":-1!==fFinal.indexOf(a)?"F":"B"),"CMP"===a&&(a="SEQ"),c.push({op:a+"."+s,ma:e.a.mode,mb:e.b.mode,a:n(e.a.value),b:n(e.b.value)})}return[e,c]}const WRITE=1,EXEC=2;function mod(e,a){return(e%a+a)%a}function exec(e,a){if(0===e.queue.length)return;const t=e.core,s=e.queue[e.index],r=s.tasks.shift(),n={...t[r]};let c,o,i,b,l;const u=e=>mod(e,t.length),d=function(a,r,n){t[a][r]=u(n),t[a].id=s.id,t[a].status=WRITE,e.dirty.add(a)};switch(n.ma){case"#":i={...t[c=r]};break;case"$":c=u(r+n.a),i={...t[c]};break;case"*":c=u(r+n.a),c=u(t[c].a+c),i={...t[c]};break;case"{":d(c=u(r+n.a),"a",t[c].a-1),c=u(t[c].a+c),i={...t[c]};break;case"}":l=u(r+n.a),c=u(t[l].a+l),i={...t[c]},d(l,"a",t[l].a+1);break;case"@":c=u(r+n.a),c=u(t[c].b+c),i={...t[c]};break;case"<":d(c=u(r+n.a),"b",t[c].b-1),c=u(t[c].b+c),i={...t[c]};break;case">":l=u(r+n.a),c=u(t[l].b+l),i={...t[c]},d(l,"b",t[l].b+1)}switch(n.mb){case"#":b={...t[o=r]};break;case"$":o=u(r+n.b),b={...t[o]};break;case"*":o=u(r+n.b),o=u(t[o].a+o),b={...t[o]};break;case"{":d(o=u(r+n.b),"a",t[o].a-1),o=u(t[o].a+o),b={...t[o]};break;case"}":l=u(r+n.b),o=u(t[l].a+l),b={...t[o]},d(l,"a",t[l].a+1);break;case"@":o=u(r+n.b),o=u(t[o].b+o),b={...t[o]};break;case"<":d(o=u(r+n.b),"b",t[o].b-1),o=u(t[o].b+o),b={...t[o]};break;case">":l=u(r+n.b),o=u(t[l].b+l),b={...t[o]},d(l,"b",t[l].b+1)}let f=[u(r+1)];const p=o;switch(n.op){case"DAT.AB":case"DAT.BA":case"DAT.A":case"DAT.B":case"DAT.F":case"DAT.X":case"DAT.I":f=[];break;case"MOV.AB":d(p,"b",i.a);break;case"MOV.BA":d(p,"a",i.b);break;case"MOV.A":d(p,"a",i.a);break;case"MOV.B":d(p,"b",i.b);break;case"MOV.F":d(p,"a",i.a),d(p,"b",i.b);break;case"MOV.X":d(p,"a",i.b),d(p,"b",i.a);break;case"MOV.I":!function(a,r){t[r].op=a.op,t[r].ma=a.ma,t[r].mb=a.mb,t[r].a=a.a,t[r].b=a.b,t[r].id=s.id,t[r].status=WRITE,e.dirty.add(r)}(i,p);break;case"ADD.AB":d(p,"b",b.b+i.a);break;case"ADD.BA":d(p,"a",b.a+i.b);break;case"ADD.A":d(p,"a",b.a+i.a);break;case"ADD.B":d(p,"b",b.b+i.b);break;case"ADD.F":case"ADD.I":d(p,"a",b.a+i.a),d(p,"b",b.b+i.b);break;case"ADD.X":d(p,"a",b.a+i.b),d(p,"b",b.b+i.a);break;case"SUB.AB":d(p,"b",b.b-i.a);break;case"SUB.BA":d(p,"a",b.a-i.b);break;case"SUB.A":d(p,"a",b.a-i.a);break;case"SUB.B":d(p,"b",b.b-i.b);break;case"SUB.F":case"SUB.I":d(p,"a",b.a-i.a),d(p,"b",b.b-i.b);break;case"SUB.X":d(p,"a",b.a-i.b),d(p,"b",b.b-i.a);break;case"MUL.AB":d(p,"b",b.b*i.a);break;case"MUL.BA":d(p,"a",b.a*i.b);break;case"MUL.A":d(p,"a",b.a*i.a);break;case"MUL.B":d(p,"b",b.b*i.b);break;case"MUL.F":case"MUL.I":d(p,"a",b.a*i.a),d(p,"b",b.b*i.b);break;case"MUL.X":d(p,"a",b.a*i.b),d(p,"b",b.b*i.a);break;case"DIV.AB":0!==i.a?d(p,"b",b.b/i.a|0):f=[];break;case"DIV.BA":0!==i.b?d(p,"a",b.a/i.b|0):f=[];break;case"DIV.A":0!==i.a?d(p,"a",b.a/i.a|0):f=[];break;case"DIV.B":0!==i.b?d(p,"b",b.b/i.b|0):f=[];break;case"DIV.F":case"DIV.I":0!==i.a&&0!==i.b?(d(p,"a",b.a/i.a|0),d(p,"b",b.b/i.b|0)):f=[];break;case"DIV.X":0!==i.a&&0!==i.b?(d(p,"a",b.a/i.b|0),d(p,"b",b.b/i.a|0)):f=[];break;case"MOD.AB":0!==i.a?d(p,"b",b.b%i.a):f=[];break;case"MOD.BA":0!==i.b?d(p,"a",b.a%i.b):f=[];break;case"MOD.A":0!==i.a?d(p,"a",b.a%i.a):f=[];break;case"MOD.B":0!==i.b?d(p,"b",b.b%i.b):f=[];break;case"MOD.F":case"MOD.I":0!==i.a&&0!==i.b?(d(p,"a",b.a%i.a),d(p,"b",b.b%i.b)):f=[];break;case"MOD.X":0!==i.a&&0!==i.b?(d(p,"a",b.a%i.b),d(p,"b",b.b%i.a)):f=[];break;case"JMP.AB":case"JMP.BA":case"JMP.A":case"JMP.B":case"JMP.F":case"JMP.X":case"JMP.I":f=[c];break;case"JMZ.A":case"JMZ.BA":0===b.a&&(f=[c]);break;case"JMZ.B":case"JMZ.AB":0===b.b&&(f=[c]);break;case"JMZ.F":case"JMZ.X":case"JMZ.I":0===b.a&&0===b.b&&(f=[c]);break;case"JMN.A":case"JMN.BA":0!==b.a&&(f=[c]);break;case"JMN.B":case"JMN.AB":0!==b.b&&(f=[c]);break;case"JMN.F":case"JMN.X":case"JMN.I":0!==b.a&&0!==b.b&&(f=[c]);break;case"DJN.A":case"DJN.BA":d(p,"a",t[p].a-1),b.a-=1,0!==b.a&&(f=[c]);break;case"DJN.B":case"DJN.AB":d(p,"b",t[p].b-1),b.b-=1,0!==b.b&&(f=[c]);break;case"DJN.F":case"DJN.X":case"DJN.I":d(p,"a",t[p].a-1),d(p,"b",t[p].b-1),b.a-=1,b.b-=1,0!==b.a&&0!==b.b&&(f=[c]);break;case"SEQ.A":i.a===b.a&&(f=[u(r+2)]);break;case"SEQ.B":i.b===b.b&&(f=[u(r+2)]);break;case"SEQ.AB":i.a===b.b&&(f=[u(r+2)]);break;case"SEQ.BA":i.b===b.a&&(f=[u(r+2)]);break;case"SEQ.F":i.a===b.a&&i.b===b.b&&(f=[u(r+2)]);break;case"SEQ.X":i.a===b.b&&i.b===b.a&&(f=[u(r+2)]);break;case"SEQ.I":i.op===b.op&&i.ma===b.ma&&i.mb===b.mb&&i.a===b.a&&i.b===b.b&&(f=[u(r+2)]);break;case"SNE.A":i.a!==b.a&&(f=[u(r+2)]);break;case"SNE.B":i.b!==b.b&&(f=[u(r+2)]);break;case"SNE.AB":i.a!==b.b&&(f=[u(r+2)]);break;case"SNE.BA":i.b!==b.a&&(f=[u(r+2)]);break;case"SNE.F":i.a===b.a&&i.b===b.b||(f=[u(r+2)]);break;case"SNE.X":i.a===b.b&&i.b===b.a||(f=[u(r+2)]);break;case"SNE.I":i.op===b.op&&i.ma===b.ma&&i.mb===b.mb&&i.a===b.a&&i.b===b.b||(f=[u(r+2)]);break;case"SLT.A":i.a<b.a&&(f=[u(r+2)]);break;case"SLT.B":i.b<b.b&&(f=[u(r+2)]);break;case"SLT.AB":i.a<b.b&&(f=[u(r+2)]);break;case"SLT.BA":i.b<b.a&&(f=[u(r+2)]);break;case"SLT.F":case"SLT.I":i.a<b.a&&i.b<b.b&&(f=[u(r+2)]);break;case"SLT.X":i.a<b.b&&i.b<b.a&&(f=[u(r+2)]);break;case"SPL.AB":case"SPL.BA":case"SPL.A":case"SPL.B":case"SPL.F":case"SPL.X":case"SPL.I":f=[u(r+1),c]}if(0!==f.length&&(t[r].id=s.id,t[r].status=EXEC,e.dirty.add(r),s.tasks=s.tasks.concat(f)),0===s.tasks.length)e.queue.splice(e.index,1);else{for(;s.tasks.length>a;)s.tasks.pop();e.index+=1}e.index>=e.queue.length&&(e.index=0,e.cycles+=1)}const blank_cell={id:0,status:0,op:"DAT.F",ma:"$",mb:"$",a:0,b:0},state=function(e){const a=Object.create(state_original);a.core=new Array(e);for(let t=0;t<e;t++)a.core[t]={...blank_cell};return a.dirty=new Set,a.queue=[],a.index=0,a.cycles=0,a},state_original={clear(){this.core=new Array(this.core.length);for(let e=0;e<this.core.length;e++)this.core[e]={...blank_cell};this.dirty=new Set,this.queue=[],this.index=0,this.cycles=0},shuffle(){let e,a=this.queue,t=a.length;for(;0!==t;)e=Math.random()*t|0,t-=1,[a[e],a[t]]=[a[t],a[e]]}};function MARS(e={}){const a=Object.create(MARS_original);return a.opts={coreSize:8e3,minDistance:100,instructionLimit:100,threadLimit:8e3,...e},a.state=state(a.opts.coreSize),a.warriors=[],a.warriors.lookup={},a}const MARS_original={clear(){this.state.clear(),this.warriors=[],this.warriors.lookup={}},load(e,a){void 0===a&&([e,a]=[a,e]);const[t,...s]=preprocess(a),r=parse(lexer(...s)),[n,c]=compile(...r);if(c.length>this.opts.instructionLimit)throw new Error("Total instructions cannot exceed "+this.opts.instructionLimit);let o=e=e||t||"Nameless",i=2;for(;void 0!==this.warriors.lookup[e];)e=o+i,i+=1;const b={name:e,org:n,code:c},l=this.warriors.push(b);return b.id=l-1,b.stage=this.stage.bind(this,b.id),this.warriors.lookup[e]=b,b},stage(e,a){if(void 0===(e="string"==typeof e?this.warriors.lookup[e]:this.warriors[e]))throw new Error("Failed to stage unknown warrior");if(void 0===a){let t=0,s=0;for(;s<this.opts.minDistance;){if((t+=1)>100)throw new Error(`Unable to stage warrior "${e.name}"`);a=Math.random()*this.opts.coreSize|0,s=1/0,this.state.queue.forEach(e=>{const t=mod(e.start-a,this.opts.coreSize),r=mod(a-e.start,this.opts.coreSize);t<s&&(s=t),r<s&&(s=r)})}}return e.code.forEach((t,s)=>{const r={id:e.id,status:WRITE,...t};r.a=mod(r.a,this.opts.coreSize),r.b=mod(r.b,this.opts.coreSize);const n=mod(a+s,this.opts.coreSize);this.state.core[n]=r,this.state.dirty.add(n)}),this.state.queue.push({id:e.id,start:a,tasks:[mod(a+e.org,this.opts.coreSize)]}),a},stageAll(){this.warriors.forEach(e=>e.stage())},step(){exec(this.state,this.opts.threadLimit)},cycle(){const e=this.state,a=this.opts.threadLimit;if(e.queue.length<2)exec(e,a);else{const t=e.cycles;for(;e.queue.length>1&&t===e.cycles;)exec(e,a)}return e.cycles}};MARS.WRITE=WRITE,MARS.EXEC=EXEC;export default MARS;