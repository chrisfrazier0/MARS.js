!function(e,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a():"function"==typeof define&&define.amd?define(a):(e=e||self).MARS=a()}(this,function(){"use strict";const e=["AB","BA","A","B","F","X","I"],a=["DAT","MOV","ADD","SUB","MUL","DIV","MOD","JMP","JMZ","JMN","DJN","CMP","SEQ","SNE","SLT","SPL","NOP"];let t,s,r,n,c;const o={},i=function(){return this},b=function(e,a=0){let t=o[e];return t?a>t.lbp&&(t.lbp=a):((t=Object.create(u)).type=t.value=e,t.lbp=a,o[e]=t),t},u={std(){const e=this.type===this.value?this.type:this.type+":"+this.value;throw new SyntaxError(`Expected instruction but found "${e}" at ${this.line}:${this.col}`)},nud(){const e=this.type===this.value?this.type:this.type+":"+this.value;throw new SyntaxError(`Expected expression but found "${e}" at ${this.line}:${this.col}`)},led(){throw new Error("Missing operator led() definition")}},d=function(e,a){const t=Object.create(b(e));return void 0!==a&&(t.value=a),t},l=function(e){if(void 0!==e&&s.type!==e){const a="\n"===e?"EOL":'"'+e+'"',t=s.type===s.value?s.type:s.type+":"+s.value;throw new SyntaxError(`Expected ${a} but found "${t}" at ${s.line}:${s.col}`)}const a=s,r=t();return(s=d("punc"===r.type?r.value:r.type,r.value)).col=r.col,s.line=r.line,a},f=function(){const e=[];for(;"eof"!==s.type;){const a=l().std();if(!1===a)break;void 0!==a&&e.push(a)}return e},h=function(){if(n.set(this.value,c),":"===s.type&&l(),"opcode"===s.type)return l().std();"eof"!==s.type&&l("\n")},p=function(){const e=d("operand");return"mode"===s.type||"*"===s.type?e.mode=l().value:e.mode="$",e.value=k(),e},k=function(e=0){let a=l(),t=a.nud();for(;e<s.lbp;)t=(a=l()).led(t);return t},A=function(e,a){const t=b(e,a);return t.led=function(e){return this.first=e,this.second=k(a),this},t};function S(e){t=e,r=d("number",0),n=new Map,c=0,l();const a=f();return[r,n,a]}b("org").std=function(){r=k(),"eof"!==s.type&&l("\n")},b("end").std=function(){return"\n"!==s.type&&"eof"!==s.type&&(r=k(),"eof"!==s.type&&l("\n")),!1},b("label").std=h,b("modifier").std=h,b("opcode").std=function(){c+=1;const e=d("instruction",this.value);return"."===s.type&&(l(),e.modifier=l("modifier").value),e.a=p(),","===s.type?(l(),e.b=p()):"DAT"!==e.value.toUpperCase()?(e.b=d("operand",d("number",0)),e.b.mode="$"):(e.b=e.a,e.a=d("operand",d("number",0)),e.a.mode="$"),"eof"!==s.type&&l("\n"),e},b("\n").std=function(){},b("number").nud=i,b("label").nud=i,b("modifier").nud=i,b("(").nud=function(){const e=k();return l(")"),e},A("+",10),A("-",10),A("*",20),A("/",20),A("%",20),function(e,a){const t=b(e);t.nud=function(){return this.first=k(a),this}}("-",30);const m=["DAT","NOP"],M=["JMP","JMZ","JMN","DJN","SPL"],B=["MOV","CMP","SEQ","SNE"],D=["ADD","SUB","MUL","DIV","MOD"];const y=1,w=2;function v(e,a){return(e%a+a)%a}function x(e,a){if(0===e.queue.length)return;const t=e.core,s=e.queue[e.index],r=s.tasks.shift(),n={...t[r]};let c,o,i,b,u;const d=e=>v(e,t.length),l=function(a,r,n){t[a][r]=d(n),t[a].id=s.id,t[a].status=y,e.dirty.add(a)};switch(n.ma){case"#":i={...t[c=r]};break;case"$":c=d(r+n.a),i={...t[c]};break;case"*":c=d(r+n.a),c=d(t[c].a+c),i={...t[c]};break;case"{":l(c=d(r+n.a),"a",t[c].a-1),c=d(t[c].a+c),i={...t[c]};break;case"}":u=d(r+n.a),c=d(t[u].a+u),i={...t[c]},l(u,"a",t[u].a+1);break;case"@":c=d(r+n.a),c=d(t[c].b+c),i={...t[c]};break;case"<":l(c=d(r+n.a),"b",t[c].b-1),c=d(t[c].b+c),i={...t[c]};break;case">":u=d(r+n.a),c=d(t[u].b+u),i={...t[c]},l(u,"b",t[u].b+1)}switch(n.mb){case"#":b={...t[o=r]};break;case"$":o=d(r+n.b),b={...t[o]};break;case"*":o=d(r+n.b),o=d(t[o].a+o),b={...t[o]};break;case"{":l(o=d(r+n.b),"a",t[o].a-1),o=d(t[o].a+o),b={...t[o]};break;case"}":u=d(r+n.b),o=d(t[u].a+u),b={...t[o]},l(u,"a",t[u].a+1);break;case"@":o=d(r+n.b),o=d(t[o].b+o),b={...t[o]};break;case"<":l(o=d(r+n.b),"b",t[o].b-1),o=d(t[o].b+o),b={...t[o]};break;case">":u=d(r+n.b),o=d(t[u].b+u),b={...t[o]},l(u,"b",t[u].b+1)}let f=[d(r+1)];const h=o;switch(n.op){case"DAT.AB":case"DAT.BA":case"DAT.A":case"DAT.B":case"DAT.F":case"DAT.X":case"DAT.I":f=[];break;case"MOV.AB":l(h,"b",i.a);break;case"MOV.BA":l(h,"a",i.b);break;case"MOV.A":l(h,"a",i.a);break;case"MOV.B":l(h,"b",i.b);break;case"MOV.F":l(h,"a",i.a),l(h,"b",i.b);break;case"MOV.X":l(h,"a",i.b),l(h,"b",i.a);break;case"MOV.I":!function(a,r){t[r].op=a.op,t[r].ma=a.ma,t[r].mb=a.mb,t[r].a=a.a,t[r].b=a.b,t[r].id=s.id,t[r].status=y,e.dirty.add(r)}(i,h);break;case"ADD.AB":l(h,"b",b.b+i.a);break;case"ADD.BA":l(h,"a",b.a+i.b);break;case"ADD.A":l(h,"a",b.a+i.a);break;case"ADD.B":l(h,"b",b.b+i.b);break;case"ADD.F":case"ADD.I":l(h,"a",b.a+i.a),l(h,"b",b.b+i.b);break;case"ADD.X":l(h,"a",b.a+i.b),l(h,"b",b.b+i.a);break;case"SUB.AB":l(h,"b",b.b-i.a);break;case"SUB.BA":l(h,"a",b.a-i.b);break;case"SUB.A":l(h,"a",b.a-i.a);break;case"SUB.B":l(h,"b",b.b-i.b);break;case"SUB.F":case"SUB.I":l(h,"a",b.a-i.a),l(h,"b",b.b-i.b);break;case"SUB.X":l(h,"a",b.a-i.b),l(h,"b",b.b-i.a);break;case"MUL.AB":l(h,"b",b.b*i.a);break;case"MUL.BA":l(h,"a",b.a*i.b);break;case"MUL.A":l(h,"a",b.a*i.a);break;case"MUL.B":l(h,"b",b.b*i.b);break;case"MUL.F":case"MUL.I":l(h,"a",b.a*i.a),l(h,"b",b.b*i.b);break;case"MUL.X":l(h,"a",b.a*i.b),l(h,"b",b.b*i.a);break;case"DIV.AB":0!==i.a?l(h,"b",b.b/i.a|0):f=[];break;case"DIV.BA":0!==i.b?l(h,"a",b.a/i.b|0):f=[];break;case"DIV.A":0!==i.a?l(h,"a",b.a/i.a|0):f=[];break;case"DIV.B":0!==i.b?l(h,"b",b.b/i.b|0):f=[];break;case"DIV.F":case"DIV.I":0!==i.a&&0!==i.b?(l(h,"a",b.a/i.a|0),l(h,"b",b.b/i.b|0)):f=[];break;case"DIV.X":0!==i.a&&0!==i.b?(l(h,"a",b.a/i.b|0),l(h,"b",b.b/i.a|0)):f=[];break;case"MOD.AB":0!==i.a?l(h,"b",b.b%i.a):f=[];break;case"MOD.BA":0!==i.b?l(h,"a",b.a%i.b):f=[];break;case"MOD.A":0!==i.a?l(h,"a",b.a%i.a):f=[];break;case"MOD.B":0!==i.b?l(h,"b",b.b%i.b):f=[];break;case"MOD.F":case"MOD.I":0!==i.a&&0!==i.b?(l(h,"a",b.a%i.a),l(h,"b",b.b%i.b)):f=[];break;case"MOD.X":0!==i.a&&0!==i.b?(l(h,"a",b.a%i.b),l(h,"b",b.b%i.a)):f=[];break;case"JMP.AB":case"JMP.BA":case"JMP.A":case"JMP.B":case"JMP.F":case"JMP.X":case"JMP.I":f=[c];break;case"JMZ.A":case"JMZ.BA":0===b.a&&(f=[c]);break;case"JMZ.B":case"JMZ.AB":0===b.b&&(f=[c]);break;case"JMZ.F":case"JMZ.X":case"JMZ.I":0===b.a&&0===b.b&&(f=[c]);break;case"JMN.A":case"JMN.BA":0!==b.a&&(f=[c]);break;case"JMN.B":case"JMN.AB":0!==b.b&&(f=[c]);break;case"JMN.F":case"JMN.X":case"JMN.I":0!==b.a&&0!==b.b&&(f=[c]);break;case"DJN.A":case"DJN.BA":l(h,"a",t[h].a-1),b.a-=1,0!==b.a&&(f=[c]);break;case"DJN.B":case"DJN.AB":l(h,"b",t[h].b-1),b.b-=1,0!==b.b&&(f=[c]);break;case"DJN.F":case"DJN.X":case"DJN.I":l(h,"a",t[h].a-1),l(h,"b",t[h].b-1),b.a-=1,b.b-=1,0!==b.a&&0!==b.b&&(f=[c]);break;case"SEQ.A":i.a===b.a&&(f=[d(r+2)]);break;case"SEQ.B":i.b===b.b&&(f=[d(r+2)]);break;case"SEQ.AB":i.a===b.b&&(f=[d(r+2)]);break;case"SEQ.BA":i.b===b.a&&(f=[d(r+2)]);break;case"SEQ.F":i.a===b.a&&i.b===b.b&&(f=[d(r+2)]);break;case"SEQ.X":i.a===b.b&&i.b===b.a&&(f=[d(r+2)]);break;case"SEQ.I":i.op===b.op&&i.ma===b.ma&&i.mb===b.mb&&i.a===b.a&&i.b===b.b&&(f=[d(r+2)]);break;case"SNE.A":i.a!==b.a&&(f=[d(r+2)]);break;case"SNE.B":i.b!==b.b&&(f=[d(r+2)]);break;case"SNE.AB":i.a!==b.b&&(f=[d(r+2)]);break;case"SNE.BA":i.b!==b.a&&(f=[d(r+2)]);break;case"SNE.F":i.a===b.a&&i.b===b.b||(f=[d(r+2)]);break;case"SNE.X":i.a===b.b&&i.b===b.a||(f=[d(r+2)]);break;case"SNE.I":i.op===b.op&&i.ma===b.ma&&i.mb===b.mb&&i.a===b.a&&i.b===b.b||(f=[d(r+2)]);break;case"SLT.A":i.a<b.a&&(f=[d(r+2)]);break;case"SLT.B":i.b<b.b&&(f=[d(r+2)]);break;case"SLT.AB":i.a<b.b&&(f=[d(r+2)]);break;case"SLT.BA":i.b<b.a&&(f=[d(r+2)]);break;case"SLT.F":case"SLT.I":i.a<b.a&&i.b<b.b&&(f=[d(r+2)]);break;case"SLT.X":i.a<b.b&&i.b<b.a&&(f=[d(r+2)]);break;case"SPL.AB":case"SPL.BA":case"SPL.A":case"SPL.B":case"SPL.F":case"SPL.X":case"SPL.I":f=[d(r+1),c]}if(0!==f.length&&(t[r].id=s.id,t[r].status=w,e.dirty.add(r),s.tasks=s.tasks.concat(f)),0===s.tasks.length)e.queue.splice(e.index,1);else{for(;s.tasks.length>a;)s.tasks.pop();e.index+=1}e.index>=e.queue.length&&(e.index=0,e.cycles+=1)}const E={id:0,status:0,op:"DAT.F",ma:"$",mb:"$",a:0,b:0},g=function(e){const a=Object.create(J);a.core=new Array(e);for(let t=0;t<e;t++)a.core[t]={...E};return a.dirty=new Set,a.queue=[],a.index=0,a.cycles=0,a},J={clear(){this.core=new Array(this.core.length);for(let e=0;e<this.core.length;e++)this.core[e]={...E};this.dirty=new Set,this.queue=[],this.index=0,this.cycles=0},shuffle(){let e,a=this.queue,t=a.length;for(;0!==t;)e=Math.random()*t|0,t-=1,[a[e],a[t]]=[a[t],a[e]]}};function L(e={}){const a=Object.create(N);return a.opts={coreSize:8e3,minDistance:100,instructionLimit:100,threadLimit:8e3,...e},a.state=g(a.opts.coreSize),a.warriors=[],a.warriors.lookup={},a}const N={clear(){this.state.clear(),this.warriors=[],this.warriors.lookup={}},load(t,s){void 0===s&&([t,s]=[s,t]);const[r,...n]=function(e){let a,t=e.match(/^[\x20\t\r\f\v]*;[\x20\t\r\f\v]*name\x20(.*)$/m);null!==t&&(a=t[1].trim());const s=new RegExp(String.raw`[\x20\t\r\f\v]*([a-z_]\w*)[\x20\t\r\f\v]*:?[\x20\t\r\f\v]*EQU\x20([^\n]*)`,"ig");let r=0,n="";const c=new Map;for(;t=s.exec(e);)c.set(t[1],t[2]),n+=e.slice(r,t.index),r=t.index+t[0].length;return[a,n+=e.slice(r),c]}(s),c=S(function(t,s=new Map){const r=new RegExp(String.raw`([\x20\t\r\f\v]+)|(;[^\n]*)|([a-zA-Z_]\w*)|([#$@{}<>])|(\d+)|([\n.,:()+\-*/%])`,"y");let n=1,c=1;const o=function(e,a){const t={type:e,value:a,line:n,col:c};return c+=a.length,t},i=function(){if(r.lastIndex>=t.length)return{type:"eof",value:"eof",line:n,col:c};const i=r.lastIndex,b=r.exec(t);if(null===b)throw new SyntaxError(`Unexpected character "${t[i]}" at ${n}:${c}`);if(void 0!==b[1]||void 0!==b[2])c+=b[0].length;else if(void 0!==b[3]){const n=b[3].toUpperCase();if("ORG"===n)return o("org",b[3]);if("END"===n)return o("end",b[3]);if(-1!==a.indexOf(n))return o("opcode",b[3]);if(-1!==e.indexOf(n))return o("modifier",b[3]);if(!s.has(b[3]))return o("label",b[3]);t=s.get(b[3])+t.slice(r.lastIndex),r.lastIndex=0}else{if(void 0!==b[4])return o("mode",b[4]);if(void 0!==b[5])return o("number",b[5]);if(void 0!==b[6]){const e=o("punc",b[6]);return"\n"===e.value&&(n+=1,c=1),e}}};return function(){let e;for(;void 0===e;)e=i();return e}}(...n)),[o,i]=function(e,a,t){let s,r=0;const n=function(e){switch(e.type){case"number":return Number(e.value);case"label":case"modifier":if(void 0===(s=a.get(e.value)))throw new SyntaxError(`Unknow label "${e.value}" at ${e.line}:${e.col}`);return s-r;case"+":return n(e.first)+n(e.second);case"-":return void 0===e.second?-n(e.first):n(e.first)-n(e.second);case"*":return n(e.first)*n(e.second);case"/":return n(e.first)/n(e.second);case"%":return n(e.first)%n(e.second);default:throw new SyntaxError(`Unexpected symbol "${e.type}:${e.value}" at ${e.line}:${e.col}`)}};e=n(e);const c=[];for(;r<t.length;r++){const e=t[r];let a=e.value.toUpperCase(),s=e.modifier&&e.modifier.toUpperCase()||"?";"?"===s&&(s=-1!==m.indexOf(a)?"F":-1!==M.indexOf(a)?"B":"#"===e.a.mode?"AB":"#"===e.b.mode?"B":-1!==B.indexOf(a)?"I":-1!==D.indexOf(a)?"F":"B"),"CMP"===a&&(a="SEQ"),c.push({op:a+"."+s,ma:e.a.mode,mb:e.b.mode,a:n(e.a.value),b:n(e.b.value)})}return[e,c]}(...c);if(i.length>this.opts.instructionLimit)throw new Error("Total instructions cannot exceed "+this.opts.instructionLimit);let b=t=t||r||"Nameless",u=2;for(;void 0!==this.warriors.lookup[t];)t=b+u,u+=1;const d={name:t,org:o,code:i},l=this.warriors.push(d);return d.id=l-1,d.stage=this.stage.bind(this,d.id),this.warriors.lookup[t]=d,d},stage(e,a){if(void 0===(e="string"==typeof e?this.warriors.lookup[e]:this.warriors[e]))throw new Error("Failed to stage unknown warrior");if(void 0===a){let t=0,s=0;for(;s<this.opts.minDistance;){if((t+=1)>100)throw new Error(`Unable to stage warrior "${e.name}"`);a=Math.random()*this.opts.coreSize|0,s=1/0,this.state.queue.forEach(e=>{const t=v(e.start-a,this.opts.coreSize),r=v(a-e.start,this.opts.coreSize);t<s&&(s=t),r<s&&(s=r)})}}return e.code.forEach((t,s)=>{const r={id:e.id,status:y,...t};r.a=v(r.a,this.opts.coreSize),r.b=v(r.b,this.opts.coreSize);const n=v(a+s,this.opts.coreSize);this.state.core[n]=r,this.state.dirty.add(n)}),this.state.queue.push({id:e.id,start:a,tasks:[v(a+e.org,this.opts.coreSize)]}),a},stageAll(){this.warriors.forEach(e=>e.stage())},step(){x(this.state,this.opts.threadLimit)},cycle(){const e=this.state,a=this.opts.threadLimit;if(e.queue.length<2)x(e,a);else{const t=e.cycles;for(;e.queue.length>1&&t===e.cycles;)x(e,a)}return e.cycles}};return L.WRITE=y,L.EXEC=w,L});