!function(e,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a():"function"==typeof define&&define.amd?define(a):(e=e||self).MARS=a()}(this,function(){"use strict";const e=["AB","BA","A","B","F","X","I"],a=["DAT","MOV","ADD","SUB","MUL","DIV","MOD","JMP","JMZ","JMN","DJN","CMP","SEQ","SNE","SLT","SPL","NOP"];let t,s,r,c,n;const o={},b=function(){return this},i=function(e,a=0){let t=o[e];return t?a>t.lbp&&(t.lbp=a):((t=Object.create(u)).type=t.value=e,t.lbp=a,o[e]=t),t},u={nud(){const e=this.type===this.value?this.type:this.type+":"+this.value;throw new SyntaxError(`Expected expression but found "${e}" at ${this.line}:${this.col}`)},led(){throw new Error("Missing operator led() definition")}},l=function(e,a){const t=Object.create(i(e));return void 0!==a&&(t.value=a),t},d=function(e){if(void 0!==e&&s.type!==e){const a="\n"===e?"instruction or EOL":'"'+e+'"',t=s.type===s.value?s.type:s.type+":"+s.value;throw new SyntaxError(`Expected ${a} but found "${t}" at ${s.line}:${s.col}`)}const a=s,r=t();return(s=l("punc"===r.type?r.value:r.type,r.value)).col=r.col,s.line=r.line,a},f=function(){const e=[];for(;"eof"!==s.type;){const a=p();if(!1===a)break;void 0!==a&&e.push(a),"eof"!==s.type&&d("\n")}return e},p=function(){let e;switch(s.type){case"org":d(),r=k();break;case"end":return d(),"\n"!==s.type&&"eof"!==s.type&&(r=k(),"eof"!==s.type&&d("\n")),!1;case"label":case"modifier":if(c.set(d().value,n),":"===s.type&&d(),"opcode"!==s.type)break;case"opcode":return n+=1,e=l("instruction",d().value),"."===s.type&&(d(),e.modifier=d("modifier").value),e.a=h(),","===s.type?(d(),e.b=h()):"DAT"!==e.value.toUpperCase()?(e.b=l("operand",l("number",0)),e.b.mode="$"):(e.b=e.a,e.a=l("operand",l("number",0)),e.a.mode="$"),e}},h=function(){const e=l("operand");return"mode"===s.type||"*"===s.type?e.mode=d().value:e.mode="$",e.value=k(),e},k=function(e=0){let a=d(),t=a.nud();for(;e<s.lbp;)t=(a=d()).led(t);return t},A=function(e,a){const t=i(e,a);return t.led=function(e){return this.first=e,this.second=k(a),this},t};function M(s){const o=function(e){const a=new RegExp(String.raw`[\x20\t\r\f\v]*([a-z_]\w*)[\x20\t\r\f\v]*:?[\x20\t\r\f\v]*EQU\x20([^\n]*)`,"ig");let t,s=0,r="";const c=new Map;for(;t=a.exec(e);)c.set(t[1],t[2]),r+=e.slice(s,t.index),s=t.index+t[0].length;return[r+=e.slice(s),c]}(s);t=function(t,s=new Map){const r=new RegExp(String.raw`([\x20\t\r\f\v]+)|(;[^\n]*)|([a-zA-Z_]\w*)|([#$@{}<>])|(\d+)|([\n.,:()+\-*/%])`,"y");let c=1,n=1;const o=function(e,a){const t={type:e,value:a,line:c,col:n};return n+=a.length,t},b=function(){if(r.lastIndex>=t.length)return{type:"eof",value:"eof",line:c,col:n};const b=r.lastIndex,i=r.exec(t);if(null===i)throw new SyntaxError(`Unexpected character "${t[b]}" at ${c}:${n}`);if(void 0!==i[1]||void 0!==i[2])n+=i[0].length;else if(void 0!==i[3]){const c=i[3].toUpperCase();if("ORG"===c)return o("org",i[3]);if("END"===c)return o("end",i[3]);if(-1!==a.indexOf(c))return o("opcode",i[3]);if(-1!==e.indexOf(c))return o("modifier",i[3]);if(!s.has(i[3]))return o("label",i[3]);t=s.get(i[3])+t.slice(r.lastIndex),r.lastIndex=0}else{if(void 0!==i[4])return o("mode",i[4]);if(void 0!==i[5])return o("number",i[5]);if(void 0!==i[6]){const e=o("punc",i[6]);return"\n"===e.value&&(c+=1,n=1),e}}};return function(){let e;for(;void 0===e;)e=b();return e}}(...o),r=l("number",0),c=new Map,n=0,d();const b=f();return[r,c,b]}i("number").nud=b,i("label").nud=b,i("modifier").nud=b,i("(").nud=function(){const e=k();return d(")"),e},A("+",10),A("-",10),A("*",20),A("/",20),A("%",20),function(e,a){const t=i(e);t.nud=function(){return this.first=k(a),this}}("-",30);const S=["DAT","NOP"],B=["JMP","JMZ","JMN","DJN","SPL"],m=["MOV","CMP","SEQ","SNE"],D=["ADD","SUB","MUL","DIV","MOD"];function y(e){let a,[t,s,r]=M(e),c=0;const n=function(e){switch(e.type){case"number":return Number(e.value);case"label":case"modifier":if(void 0===(a=s.get(e.value)))throw new SyntaxError(`Unknow label "${e.value}" at ${e.line}:${e.col}`);return a-c;case"+":return n(e.first)+n(e.second);case"-":return void 0===e.second?-n(e.first):n(e.first)-n(e.second);case"*":return n(e.first)*n(e.second);case"/":return n(e.first)/n(e.second);case"%":return n(e.first)%n(e.second);default:throw new SyntaxError(`Unexpected symbol "${e.type}:${e.value}" at ${e.line}:${e.col}`)}};t=n(t);const o=[];for(;c<r.length;c++){const e=r[c];let a=e.value.toUpperCase(),t=e.modifier&&e.modifier.toUpperCase()||"?";"?"===t&&(t=-1!==S.indexOf(a)?"F":-1!==B.indexOf(a)?"B":"#"===e.a.mode?"AB":"#"===e.b.mode?"B":-1!==m.indexOf(a)?"I":-1!==D.indexOf(a)?"F":"B"),"CMP"===a&&(a="SEQ"),o.push({op:a+"."+t,ma:e.a.mode,mb:e.b.mode,a:n(e.a.value),b:n(e.b.value)})}return[t,o]}const w=1,v=2;function x(e,a){return(e%a+a)%a}function E(e,a){if(0===e.queue.length)return;const t=e.core,s=e.queue[e.index],r=s.tasks.shift(),c={...t[r]};let n,o,b,i,u;const l=e=>x(e,t.length),d=function(a,r,c){t[a][r]=l(c),t[a].id=s.id,t[a].status=w,e.dirty.add(a)};switch(c.ma){case"#":b={...t[n=r]};break;case"$":n=l(r+c.a),b={...t[n]};break;case"*":n=l(r+c.a),n=l(t[n].a+n),b={...t[n]};break;case"{":d(n=l(r+c.a),"a",t[n].a-1),n=l(t[n].a+n),b={...t[n]};break;case"}":u=l(r+c.a),n=l(t[u].a+u),b={...t[n]},d(u,"a",t[u].a+1);break;case"@":n=l(r+c.a),n=l(t[n].b+n),b={...t[n]};break;case"<":d(n=l(r+c.a),"b",t[n].b-1),n=l(t[n].b+n),b={...t[n]};break;case">":u=l(r+c.a),n=l(t[u].b+u),b={...t[n]},d(u,"b",t[u].b+1)}switch(c.mb){case"#":i={...t[o=r]};break;case"$":o=l(r+c.b),i={...t[o]};break;case"*":o=l(r+c.b),o=l(t[o].a+o),i={...t[o]};break;case"{":d(o=l(r+c.b),"a",t[o].a-1),o=l(t[o].a+o),i={...t[o]};break;case"}":u=l(r+c.b),o=l(t[u].a+u),i={...t[o]},d(u,"a",t[u].a+1);break;case"@":o=l(r+c.b),o=l(t[o].b+o),i={...t[o]};break;case"<":d(o=l(r+c.b),"b",t[o].b-1),o=l(t[o].b+o),i={...t[o]};break;case">":u=l(r+c.b),o=l(t[u].b+u),i={...t[o]},d(u,"b",t[u].b+1)}let f=[l(r+1)];const p=o;switch(c.op){case"DAT.AB":case"DAT.BA":case"DAT.A":case"DAT.B":case"DAT.F":case"DAT.X":case"DAT.I":f=[];break;case"MOV.AB":d(p,"b",b.a);break;case"MOV.BA":d(p,"a",b.b);break;case"MOV.A":d(p,"a",b.a);break;case"MOV.B":d(p,"b",b.b);break;case"MOV.F":d(p,"a",b.a),d(p,"b",b.b);break;case"MOV.X":d(p,"a",b.b),d(p,"b",b.a);break;case"MOV.I":!function(a,r){t[r].op=a.op,t[r].ma=a.ma,t[r].mb=a.mb,t[r].a=a.a,t[r].b=a.b,t[r].id=s.id,t[r].status=w,e.dirty.add(r)}(b,p);break;case"ADD.AB":d(p,"b",i.b+b.a);break;case"ADD.BA":d(p,"a",i.a+b.b);break;case"ADD.A":d(p,"a",i.a+b.a);break;case"ADD.B":d(p,"b",i.b+b.b);break;case"ADD.F":case"ADD.I":d(p,"a",i.a+b.a),d(p,"b",i.b+b.b);break;case"ADD.X":d(p,"a",i.a+b.b),d(p,"b",i.b+b.a);break;case"SUB.AB":d(p,"b",i.b-b.a);break;case"SUB.BA":d(p,"a",i.a-b.b);break;case"SUB.A":d(p,"a",i.a-b.a);break;case"SUB.B":d(p,"b",i.b-b.b);break;case"SUB.F":case"SUB.I":d(p,"a",i.a-b.a),d(p,"b",i.b-b.b);break;case"SUB.X":d(p,"a",i.a-b.b),d(p,"b",i.b-b.a);break;case"MUL.AB":d(p,"b",i.b*b.a);break;case"MUL.BA":d(p,"a",i.a*b.b);break;case"MUL.A":d(p,"a",i.a*b.a);break;case"MUL.B":d(p,"b",i.b*b.b);break;case"MUL.F":case"MUL.I":d(p,"a",i.a*b.a),d(p,"b",i.b*b.b);break;case"MUL.X":d(p,"a",i.a*b.b),d(p,"b",i.b*b.a);break;case"DIV.AB":0!==b.a?d(p,"b",i.b/b.a|0):f=[];break;case"DIV.BA":0!==b.b?d(p,"a",i.a/b.b|0):f=[];break;case"DIV.A":0!==b.a?d(p,"a",i.a/b.a|0):f=[];break;case"DIV.B":0!==b.b?d(p,"b",i.b/b.b|0):f=[];break;case"DIV.F":case"DIV.I":0!==b.a&&0!==b.b?(d(p,"a",i.a/b.a|0),d(p,"b",i.b/b.b|0)):f=[];break;case"DIV.X":0!==b.a&&0!==b.b?(d(p,"a",i.a/b.b|0),d(p,"b",i.b/b.a|0)):f=[];break;case"MOD.AB":0!==b.a?d(p,"b",i.b%b.a):f=[];break;case"MOD.BA":0!==b.b?d(p,"a",i.a%b.b):f=[];break;case"MOD.A":0!==b.a?d(p,"a",i.a%b.a):f=[];break;case"MOD.B":0!==b.b?d(p,"b",i.b%b.b):f=[];break;case"MOD.F":case"MOD.I":0!==b.a&&0!==b.b?(d(p,"a",i.a%b.a),d(p,"b",i.b%b.b)):f=[];break;case"MOD.X":0!==b.a&&0!==b.b?(d(p,"a",i.a%b.b),d(p,"b",i.b%b.a)):f=[];break;case"JMP.AB":case"JMP.BA":case"JMP.A":case"JMP.B":case"JMP.F":case"JMP.X":case"JMP.I":f=[n];break;case"JMZ.A":case"JMZ.BA":0===i.a&&(f=[n]);break;case"JMZ.B":case"JMZ.AB":0===i.b&&(f=[n]);break;case"JMZ.F":case"JMZ.X":case"JMZ.I":0===i.a&&0===i.b&&(f=[n]);break;case"JMN.A":case"JMN.BA":0!==i.a&&(f=[n]);break;case"JMN.B":case"JMN.AB":0!==i.b&&(f=[n]);break;case"JMN.F":case"JMN.X":case"JMN.I":0!==i.a&&0!==i.b&&(f=[n]);break;case"DJN.A":case"DJN.BA":d(p,"a",t[p].a-1),i.a-=1,0!==i.a&&(f=[n]);break;case"DJN.B":case"DJN.AB":d(p,"b",t[p].b-1),i.b-=1,0!==i.b&&(f=[n]);break;case"DJN.F":case"DJN.X":case"DJN.I":d(p,"a",t[p].a-1),d(p,"b",t[p].b-1),i.a-=1,i.b-=1,0!==i.a&&0!==i.b&&(f=[n]);break;case"SEQ.A":b.a===i.a&&(f=[l(r+2)]);break;case"SEQ.B":b.b===i.b&&(f=[l(r+2)]);break;case"SEQ.AB":b.a===i.b&&(f=[l(r+2)]);break;case"SEQ.BA":b.b===i.a&&(f=[l(r+2)]);break;case"SEQ.F":b.a===i.a&&b.b===i.b&&(f=[l(r+2)]);break;case"SEQ.X":b.a===i.b&&b.b===i.a&&(f=[l(r+2)]);break;case"SEQ.I":b.op===i.op&&b.ma===i.ma&&b.mb===i.mb&&b.a===i.a&&b.b===i.b&&(f=[l(r+2)]);break;case"SNE.A":b.a!==i.a&&(f=[l(r+2)]);break;case"SNE.B":b.b!==i.b&&(f=[l(r+2)]);break;case"SNE.AB":b.a!==i.b&&(f=[l(r+2)]);break;case"SNE.BA":b.b!==i.a&&(f=[l(r+2)]);break;case"SNE.F":b.a===i.a&&b.b===i.b||(f=[l(r+2)]);break;case"SNE.X":b.a===i.b&&b.b===i.a||(f=[l(r+2)]);break;case"SNE.I":b.op===i.op&&b.ma===i.ma&&b.mb===i.mb&&b.a===i.a&&b.b===i.b||(f=[l(r+2)]);break;case"SLT.A":b.a<i.a&&(f=[l(r+2)]);break;case"SLT.B":b.b<i.b&&(f=[l(r+2)]);break;case"SLT.AB":b.a<i.b&&(f=[l(r+2)]);break;case"SLT.BA":b.b<i.a&&(f=[l(r+2)]);break;case"SLT.F":case"SLT.I":b.a<i.a&&b.b<i.b&&(f=[l(r+2)]);break;case"SLT.X":b.a<i.b&&b.b<i.a&&(f=[l(r+2)]);break;case"SPL.AB":case"SPL.BA":case"SPL.A":case"SPL.B":case"SPL.F":case"SPL.X":case"SPL.I":f=[l(r+1),n]}if(0!==f.length&&(t[r].id=s.id,t[r].status=v,e.dirty.add(r),s.tasks=s.tasks.concat(f)),0===s.tasks.length)e.queue.splice(e.index,1);else{for(;s.tasks.length>a;)s.tasks.pop();e.index+=1}e.index>=e.queue.length&&(e.index=0,e.cycles+=1)}const g={id:0,status:0,op:"DAT.F",ma:"$",mb:"$",a:0,b:0},J=function(e){const a=Object.create(L);a.core=new Array(e);for(let t=0;t<e;t++)a.core[t]={...g};return a.dirty=new Set,a.queue=[],a.index=0,a.cycles=0,a},L={clear(){this.core=new Array(this.core.length);for(let e=0;e<this.core.length;e++)this.core[e]={...g};this.dirty=new Set,this.queue=[],this.index=0,this.cycles=0},shuffle(){let e,a=this.queue,t=a.length;for(;0!==t;)e=Math.random()*t|0,t-=1,[a[e],a[t]]=[a[t],a[e]]}};function O(e={}){const a=Object.create(I);return a.opts={coreSize:8e3,minDistance:100,instructionLimit:100,threadLimit:8e3,...e},a.state=J(a.opts.coreSize),a.warriors=[],a.warriors.lookup={},a}const I={clear(){this.state.clear(),this.warriors=[],this.warriors.lookup={}},load(e,a){let t=e,s=2;for(;void 0!==this.warriors.lookup[e];)e=t+s,s+=1;const[r,c]=y(a);if(c.length>this.opts.instructionLimit)throw new Error("Total instructions cannot exceed "+this.opts.instructionLimit);const n={name:e,org:r,code:c},o=this.warriors.push(n);return n.id=o-1,n.stage=this.stage.bind(this,n.id),this.warriors.lookup[e]=n,n},stage(e){if(void 0===(e="string"==typeof e?this.warriors.lookup[e]:this.warriors[e]))throw new Error("Failed to stage unknown warrior");let a,t=0,s=0;for(;s<this.opts.minDistance;){if((t+=1)>100)throw new Error(`Unable to load warrior "${e.name}"`);a=Math.random()*this.opts.coreSize|0,s=1/0,this.state.queue.forEach(e=>{const t=x(e.start-a,this.opts.coreSize),r=x(a-e.start,this.opts.coreSize);t<s&&(s=t),r<s&&(s=r)})}return e.code.forEach((t,s)=>{const r={id:e.id,status:w,...t};r.a=x(r.a,this.opts.coreSize),r.b=x(r.b,this.opts.coreSize);const c=x(a+s,this.opts.coreSize);this.state.core[c]=r,this.state.dirty.add(c)}),this.state.queue.push({id:e.id,start:a,tasks:[x(a+e.org,this.opts.coreSize)]}),a},stageAll(){this.warriors.forEach(e=>e.stage())},step(){E(this.state,this.opts.threadLimit)},cycle(){const e=this.state,a=this.opts.threadLimit;if(e.queue.length<2)E(e,a);else{const t=e.cycles;for(;e.queue.length>1&&t===e.cycles;)E(e,a)}return e.cycles}};return O.WRITE=w,O.EXEC=v,O.compile=y,O});