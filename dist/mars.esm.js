function preprocess(e){const a=new RegExp(String.raw`[\x20\t\r\f\v]*([a-z_]\w*)[\x20\t\r\f\v]*:?[\x20\t\r\f\v]*EQU\x20([^\n]*)`,"ig");let t,s=0,r="";const c=new Map;for(;t=a.exec(e);)c.set(t[1],t[2]),r+=e.slice(s,t.index),s=t.index+t[0].length;return[r+=e.slice(s),c]}const modifiers=["AB","BA","A","B","F","X","I"],opcodes=["DAT","MOV","ADD","SUB","MUL","DIV","MOD","JMP","JMZ","JMN","DJN","CMP","SEQ","SNE","SLT","SPL","NOP"];function lexer(e,a=new Map){const t=new RegExp(String.raw`([\x20\t\r\f\v]+)|(;[^\n]*)|([a-zA-Z_]\w*)|([#$@{}<>])|(\d+)|([\n.,:()+\-*/%])`,"y");let s=1,r=1;const c=function(e,a){const t={type:e,value:a,line:s,col:r};return r+=a.length,t},n=function(){if(t.lastIndex>=e.length)return{type:"eof",value:"eof",line:s,col:r};const n=t.lastIndex,o=t.exec(e);if(null===o)throw new SyntaxError(`Unexpected character "${e[n]}" at ${s}:${r}`);if(void 0!==o[1]||void 0!==o[2])r+=o[0].length;else if(void 0!==o[3]){const s=o[3].toUpperCase();if("ORG"===s)return c("org",o[3]);if("END"===s)return c("end",o[3]);if(-1!==opcodes.indexOf(s))return c("opcode",o[3]);if(-1!==modifiers.indexOf(s))return c("modifier",o[3]);if(!a.has(o[3]))return c("label",o[3]);e=a.get(o[3])+e.slice(t.lastIndex),t.lastIndex=0}else{if(void 0!==o[4])return c("mode",o[4]);if(void 0!==o[5])return c("number",o[5]);if(void 0!==o[6]){const e=c("punc",o[6]);return"\n"===e.value&&(s+=1,r=1),e}}};return function(){let e;for(;void 0===e;)e=n();return e}}let lex,la,org,labels,count;const symbol_table={},itself=function(){return this},symbol=function(e,a=0){let t=symbol_table[e];return t?a>t.lbp&&(t.lbp=a):((t=Object.create(symbol_original)).type=t.value=e,t.lbp=a,symbol_table[e]=t),t},symbol_original={nud(){const e=this.type===this.value?this.type:this.type+":"+this.value;throw new SyntaxError(`Expected expression but found "${e}" at ${this.line}:${this.col}`)},led(){throw new Error("Missing operator led() definition")}},create_symbol=function(e,a){const t=Object.create(symbol(e));return void 0!==a&&(t.value=a),t},advance=function(e){if(void 0!==e&&la.type!==e){const a="\n"===e?"instruction or EOL":'"'+e+'"',t=la.type===la.value?la.type:la.type+":"+la.value;throw new SyntaxError(`Expected ${a} but found "${t}" at ${la.line}:${la.col}`)}const a=la,t=lex();return(la=create_symbol("punc"===t.type?t.value:t.type,t.value)).col=t.col,la.line=t.line,a},statements=function(){const e=[];for(;"eof"!==la.type;){const a=statement();if(!1===a)break;void 0!==a&&e.push(a),"eof"!==la.type&&advance("\n")}return e},statement=function(){let e;switch(la.type){case"org":advance(),org=expression();break;case"end":return advance(),"\n"!==la.type&&"eof"!==la.type&&(org=expression(),"eof"!==la.type&&advance("\n")),!1;case"label":case"modifier":if(labels.set(advance().value,count),":"===la.type&&advance(),"opcode"!==la.type)break;case"opcode":return count+=1,e=create_symbol("instruction",advance().value),"."===la.type&&(advance(),e.modifier=advance("modifier").value),e.a=reference(),","===la.type?(advance(),e.b=reference()):"DAT"!==e.value.toUpperCase()?(e.b=create_symbol("operand",create_symbol("number",0)),e.b.mode="$"):(e.b=e.a,e.a=create_symbol("operand",create_symbol("number",0)),e.a.mode="$"),e}},reference=function(){const e=create_symbol("operand");return"mode"===la.type||"*"===la.type?e.mode=advance().value:e.mode="$",e.value=expression(),e},expression=function(e=0){let a=advance(),t=a.nud();for(;e<la.lbp;)t=(a=advance()).led(t);return t},infix=function(e,a){const t=symbol(e,a);return t.led=function(e){return this.first=e,this.second=expression(a),this},t},prefix=function(e,a){const t=symbol(e);return t.nud=function(){return this.first=expression(a),this},t};function parse(e){const a=preprocess(e);lex=lexer(...a),org=create_symbol("number",0),labels=new Map,count=0,advance();const t=statements();return[org,labels,t]}symbol("number").nud=itself,symbol("label").nud=itself,symbol("modifier").nud=itself,symbol("(").nud=function(){const e=expression();return advance(")"),e},infix("+",10),infix("-",10),infix("*",20),infix("/",20),infix("%",20),prefix("-",30);const fDefault=["DAT","NOP"],bDefault=["JMP","JMZ","JMN","DJN","SPL"],iFinal=["MOV","CMP","SEQ","SNE"],fFinal=["ADD","SUB","MUL","DIV","MOD"];function compile(e){let a,[t,s,r]=parse(e),c=0;const n=function(e){switch(e.type){case"number":return Number(e.value);case"label":case"modifier":if(void 0===(a=s.get(e.value)))throw new SyntaxError(`Unknow label "${e.value}" at ${e.line}:${e.col}`);return a-c;case"+":return n(e.first)+n(e.second);case"-":return void 0===e.second?-n(e.first):n(e.first)-n(e.second);case"*":return n(e.first)*n(e.second);case"/":return n(e.first)/n(e.second);case"%":return n(e.first)%n(e.second);default:throw new SyntaxError(`Unexpected symbol "${e.type}:${e.value}" at ${e.line}:${e.col}`)}};t=n(t);const o=[];for(;c<r.length;c++){const e=r[c];let a=e.value.toUpperCase(),t=e.modifier&&e.modifier.toUpperCase()||"?";"?"===t&&(t=-1!==fDefault.indexOf(a)?"F":-1!==bDefault.indexOf(a)?"B":"#"===e.a.mode?"AB":"#"===e.b.mode?"B":-1!==iFinal.indexOf(a)?"I":-1!==fFinal.indexOf(a)?"F":"B"),"CMP"===a&&(a="SEQ"),o.push({op:a+"."+t,ma:e.a.mode,mb:e.b.mode,a:n(e.a.value),b:n(e.b.value)})}return[t,o]}const WRITE=1,EXEC=2;function mod(e,a){return(e%a+a)%a}function exec(e,a){if(0===e.queue.length)return;const t=e.core,s=e.queue[e.index],r=s.tasks.shift(),c={...t[r]};let n,o,b,i,l;const u=e=>mod(e,t.length),d=function(a,r,c){t[a][r]=u(c),t[a].id=s.id,t[a].status=WRITE,e.dirty.add(a)};switch(c.ma){case"#":b={...t[n=r]};break;case"$":n=u(r+c.a),b={...t[n]};break;case"*":n=u(r+c.a),n=u(t[n].a+n),b={...t[n]};break;case"{":d(n=u(r+c.a),"a",t[n].a-1),n=u(t[n].a+n),b={...t[n]};break;case"}":l=u(r+c.a),n=u(t[l].a+l),b={...t[n]},d(l,"a",t[l].a+1);break;case"@":n=u(r+c.a),n=u(t[n].b+n),b={...t[n]};break;case"<":d(n=u(r+c.a),"b",t[n].b-1),n=u(t[n].b+n),b={...t[n]};break;case">":l=u(r+c.a),n=u(t[l].b+l),b={...t[n]},d(l,"b",t[l].b+1)}switch(c.mb){case"#":i={...t[o=r]};break;case"$":o=u(r+c.b),i={...t[o]};break;case"*":o=u(r+c.b),o=u(t[o].a+o),i={...t[o]};break;case"{":d(o=u(r+c.b),"a",t[o].a-1),o=u(t[o].a+o),i={...t[o]};break;case"}":l=u(r+c.b),o=u(t[l].a+l),i={...t[o]},d(l,"a",t[l].a+1);break;case"@":o=u(r+c.b),o=u(t[o].b+o),i={...t[o]};break;case"<":d(o=u(r+c.b),"b",t[o].b-1),o=u(t[o].b+o),i={...t[o]};break;case">":l=u(r+c.b),o=u(t[l].b+l),i={...t[o]},d(l,"b",t[l].b+1)}let f=[u(r+1)];const p=o;switch(c.op){case"DAT.AB":case"DAT.BA":case"DAT.A":case"DAT.B":case"DAT.F":case"DAT.X":case"DAT.I":f=[];break;case"MOV.AB":d(p,"b",b.a);break;case"MOV.BA":d(p,"a",b.b);break;case"MOV.A":d(p,"a",b.a);break;case"MOV.B":d(p,"b",b.b);break;case"MOV.F":d(p,"a",b.a),d(p,"b",b.b);break;case"MOV.X":d(p,"a",b.b),d(p,"b",b.a);break;case"MOV.I":!function(a,r){t[r].op=a.op,t[r].ma=a.ma,t[r].mb=a.mb,t[r].a=a.a,t[r].b=a.b,t[r].id=s.id,t[r].status=WRITE,e.dirty.add(r)}(b,p);break;case"ADD.AB":d(p,"b",i.b+b.a);break;case"ADD.BA":d(p,"a",i.a+b.b);break;case"ADD.A":d(p,"a",i.a+b.a);break;case"ADD.B":d(p,"b",i.b+b.b);break;case"ADD.F":case"ADD.I":d(p,"a",i.a+b.a),d(p,"b",i.b+b.b);break;case"ADD.X":d(p,"a",i.a+b.b),d(p,"b",i.b+b.a);break;case"SUB.AB":d(p,"b",i.b-b.a);break;case"SUB.BA":d(p,"a",i.a-b.b);break;case"SUB.A":d(p,"a",i.a-b.a);break;case"SUB.B":d(p,"b",i.b-b.b);break;case"SUB.F":case"SUB.I":d(p,"a",i.a-b.a),d(p,"b",i.b-b.b);break;case"SUB.X":d(p,"a",i.a-b.b),d(p,"b",i.b-b.a);break;case"MUL.AB":d(p,"b",i.b*b.a);break;case"MUL.BA":d(p,"a",i.a*b.b);break;case"MUL.A":d(p,"a",i.a*b.a);break;case"MUL.B":d(p,"b",i.b*b.b);break;case"MUL.F":case"MUL.I":d(p,"a",i.a*b.a),d(p,"b",i.b*b.b);break;case"MUL.X":d(p,"a",i.a*b.b),d(p,"b",i.b*b.a);break;case"DIV.AB":0!==b.a?d(p,"b",i.b/b.a|0):f=[];break;case"DIV.BA":0!==b.b?d(p,"a",i.a/b.b|0):f=[];break;case"DIV.A":0!==b.a?d(p,"a",i.a/b.a|0):f=[];break;case"DIV.B":0!==b.b?d(p,"b",i.b/b.b|0):f=[];break;case"DIV.F":case"DIV.I":0!==b.a&&0!==b.b?(d(p,"a",i.a/b.a|0),d(p,"b",i.b/b.b|0)):f=[];break;case"DIV.X":0!==b.a&&0!==b.b?(d(p,"a",i.a/b.b|0),d(p,"b",i.b/b.a|0)):f=[];break;case"MOD.AB":0!==b.a?d(p,"b",i.b%b.a):f=[];break;case"MOD.BA":0!==b.b?d(p,"a",i.a%b.b):f=[];break;case"MOD.A":0!==b.a?d(p,"a",i.a%b.a):f=[];break;case"MOD.B":0!==b.b?d(p,"b",i.b%b.b):f=[];break;case"MOD.F":case"MOD.I":0!==b.a&&0!==b.b?(d(p,"a",i.a%b.a),d(p,"b",i.b%b.b)):f=[];break;case"MOD.X":0!==b.a&&0!==b.b?(d(p,"a",i.a%b.b),d(p,"b",i.b%b.a)):f=[];break;case"JMP.AB":case"JMP.BA":case"JMP.A":case"JMP.B":case"JMP.F":case"JMP.X":case"JMP.I":f=[n];break;case"JMZ.A":case"JMZ.BA":0===i.a&&(f=[n]);break;case"JMZ.B":case"JMZ.AB":0===i.b&&(f=[n]);break;case"JMZ.F":case"JMZ.X":case"JMZ.I":0===i.a&&0===i.b&&(f=[n]);break;case"JMN.A":case"JMN.BA":0!==i.a&&(f=[n]);break;case"JMN.B":case"JMN.AB":0!==i.b&&(f=[n]);break;case"JMN.F":case"JMN.X":case"JMN.I":0!==i.a&&0!==i.b&&(f=[n]);break;case"DJN.A":case"DJN.BA":d(p,"a",t[p].a-1),i.a-=1,0!==i.a&&(f=[n]);break;case"DJN.B":case"DJN.AB":d(p,"b",t[p].b-1),i.b-=1,0!==i.b&&(f=[n]);break;case"DJN.F":case"DJN.X":case"DJN.I":d(p,"a",t[p].a-1),d(p,"b",t[p].b-1),i.a-=1,i.b-=1,0!==i.a&&0!==i.b&&(f=[n]);break;case"SEQ.A":b.a===i.a&&(f=[u(r+2)]);break;case"SEQ.B":b.b===i.b&&(f=[u(r+2)]);break;case"SEQ.AB":b.a===i.b&&(f=[u(r+2)]);break;case"SEQ.BA":b.b===i.a&&(f=[u(r+2)]);break;case"SEQ.F":b.a===i.a&&b.b===i.b&&(f=[u(r+2)]);break;case"SEQ.X":b.a===i.b&&b.b===i.a&&(f=[u(r+2)]);break;case"SEQ.I":b.op===i.op&&b.ma===i.ma&&b.mb===i.mb&&b.a===i.a&&b.b===i.b&&(f=[u(r+2)]);break;case"SNE.A":b.a!==i.a&&(f=[u(r+2)]);break;case"SNE.B":b.b!==i.b&&(f=[u(r+2)]);break;case"SNE.AB":b.a!==i.b&&(f=[u(r+2)]);break;case"SNE.BA":b.b!==i.a&&(f=[u(r+2)]);break;case"SNE.F":b.a===i.a&&b.b===i.b||(f=[u(r+2)]);break;case"SNE.X":b.a===i.b&&b.b===i.a||(f=[u(r+2)]);break;case"SNE.I":b.op===i.op&&b.ma===i.ma&&b.mb===i.mb&&b.a===i.a&&b.b===i.b||(f=[u(r+2)]);break;case"SLT.A":b.a<i.a&&(f=[u(r+2)]);break;case"SLT.B":b.b<i.b&&(f=[u(r+2)]);break;case"SLT.AB":b.a<i.b&&(f=[u(r+2)]);break;case"SLT.BA":b.b<i.a&&(f=[u(r+2)]);break;case"SLT.F":case"SLT.I":b.a<i.a&&b.b<i.b&&(f=[u(r+2)]);break;case"SLT.X":b.a<i.b&&b.b<i.a&&(f=[u(r+2)]);break;case"SPL.AB":case"SPL.BA":case"SPL.A":case"SPL.B":case"SPL.F":case"SPL.X":case"SPL.I":f=[u(r+1),n]}if(0!==f.length&&(t[r].id=s.id,t[r].status=EXEC,e.dirty.add(r),s.tasks=s.tasks.concat(f)),0===s.tasks.length)e.queue.splice(e.index,1);else{for(;s.tasks.length>a;)s.tasks.pop();e.index+=1}e.index>=e.queue.length&&(e.index=0,e.cycles+=1)}const blank_cell={id:0,status:0,op:"DAT.F",ma:"$",mb:"$",a:0,b:0},state=function(e){const a=Object.create(state_original);a.core=new Array(e);for(let t=0;t<e;t++)a.core[t]={...blank_cell};return a.dirty=new Set,a.queue=[],a.index=0,a.cycles=0,a},state_original={clear(){this.core=new Array(this.core.length);for(let e=0;e<this.core.length;e++)this.core[e]={...blank_cell};this.dirty=new Set,this.queue=[],this.index=0,this.cycles=0},shuffle(){let e,a=this.queue,t=a.length;for(;0!==t;)e=Math.random()*t|0,t-=1,[a[e],a[t]]=[a[t],a[e]]}};function MARS(e={}){const a=Object.create(MARS_original);return a.opts={coreSize:8e3,minDistance:100,instructionLimit:100,threadLimit:8e3,...e},a.state=state(a.opts.coreSize),a.warriors=[],a.warriors.lookup={},a}const MARS_original={clear(){this.state.clear(),this.warriors=[],this.warriors.lookup={}},load(e,a){let t=e,s=2;for(;void 0!==this.warriors.lookup[e];)e=t+s,s+=1;const[r,c]=compile(a);if(c.length>this.opts.instructionLimit)throw new Error("Total instructions cannot exceed "+this.opts.instructionLimit);const n={name:e,org:r,code:c},o=this.warriors.push(n);return n.id=o-1,n.stage=this.stage.bind(this,n.id),this.warriors.lookup[e]=n,n},stage(e){if(void 0===(e="string"==typeof e?this.warriors.lookup[e]:this.warriors[e]))throw new Error("Failed to stage unknown warrior");let a,t=0,s=0;for(;s<this.opts.minDistance;){if((t+=1)>100)throw new Error(`Unable to load warrior "${e.name}"`);a=Math.random()*this.opts.coreSize|0,s=1/0,this.state.queue.forEach(e=>{const t=mod(e.start-a,this.opts.coreSize),r=mod(a-e.start,this.opts.coreSize);t<s&&(s=t),r<s&&(s=r)})}return e.code.forEach((t,s)=>{const r={id:e.id,status:WRITE,...t};r.a=mod(r.a,this.opts.coreSize),r.b=mod(r.b,this.opts.coreSize);const c=mod(a+s,this.opts.coreSize);this.state.core[c]=r,this.state.dirty.add(c)}),this.state.queue.push({id:e.id,start:a,tasks:[mod(a+e.org,this.opts.coreSize)]}),a},stageAll(){this.warriors.forEach(e=>e.stage())},step(){exec(this.state,this.opts.threadLimit)},cycle(){const e=this.state,a=this.opts.threadLimit;if(e.queue.length<2)exec(e,a);else{const t=e.cycles;for(;e.queue.length>1&&t===e.cycles;)exec(e,a)}return e.cycles}};MARS.WRITE=WRITE,MARS.EXEC=EXEC,MARS.compile=compile;export default MARS;